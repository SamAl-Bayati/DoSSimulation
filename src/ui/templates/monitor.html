<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Monitor</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

  <!-- Use a known-good combination of Chart.js, Luxon, adapter, and plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>

  <!-- Socket.IO v3 client -->
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
  
  <!-- chartjs-plugin-streaming 2.0.0 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0"></script>
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4">Real-Time Monitor</h1>
    <div class="row">
      <div class="col-md-6">
        <h3>Connections Over Time</h3>
        <canvas id="connectionsChart" width="400" height="200"></canvas>
      </div>
      <div class="col-md-6">
        <h3>Denied Connections Over Time</h3>
        <canvas id="deniedChart" width="400" height="200"></canvas>
      </div>
    </div>
    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">Back to Dashboard</a>
  </div>

  <script>
    // Force websocket transport and add logging for debugging.
    var socket = io({ transports: ['websocket'] });

    socket.on('connect', function() {
      console.log("Socket.IO: Connected via WebSocket.");
    });
    socket.on('connect_error', function(err) {
      console.error("Socket.IO: Connection error:", err);
    });
    socket.on('disconnect', function(reason) {
      console.log("Socket.IO: Disconnected. Reason:", reason);
    });
    
    // When we receive new metrics, push data into the charts and update
    socket.on('metrics', function(data) {
      console.log("Received metrics:", data);
      var now = Date.now();
      connectionsChart.data.datasets[0].data.push({ x: now, y: data.current_connections });
      deniedChart.data.datasets[0].data.push({ x: now, y: data.denied_by_threshold });
      deniedChart.data.datasets[1].data.push({ x: now, y: data.denied_by_blocked });
      // Use "none" or just .update() if you don't want "quiet" mode
      connectionsChart.update('none');
      deniedChart.update('none');
    });

    // Set up the "Connections" chart
    var ctx1 = document.getElementById('connectionsChart').getContext('2d');
    var connectionsChart = new Chart(ctx1, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Current Connections',
          borderColor: 'rgba(75, 192, 192, 1)',
          fill: false,
          data: []
        }]
      },
      options: {
        scales: {
          x: {
            type: 'realtime',
            realtime: {
              delay: 2000,
              refresh: 1000,
              onRefresh: function(chart) {
                // We push new data on 'metrics' event, so nothing here
              }
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Connections'
            }
          }
        }
      }
    });

    // Set up the "Denied" chart
    var ctx2 = document.getElementById('deniedChart').getContext('2d');
    var deniedChart = new Chart(ctx2, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Denied by Threshold',
            borderColor: 'rgba(255, 159, 64, 1)',
            fill: false,
            data: []
          },
          {
            label: 'Denied (Already Blocked)',
            borderColor: 'rgba(255, 99, 132, 1)',
            fill: false,
            data: []
          }
        ]
      },
      options: {
        scales: {
          x: {
            type: 'realtime',
            realtime: {
              delay: 2000,
              refresh: 1000,
              onRefresh: function(chart) {
                // We push new data on 'metrics' event
              }
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Denied Connections'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
