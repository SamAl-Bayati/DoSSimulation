<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Monitor</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

  <!-- Chart.js 3.7.1 plus Luxon date adapter (for time axis). -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>

  <!-- Socket.IO v3 client -->
  <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4">Real-Time Monitor (Non-Streaming)</h1>
    <p>
      This page uses a standard time axis; we push data each time a 
      <code>metrics</code> event arrives. Old points are pruned so the chart 
      doesnâ€™t grow unbounded.
    </p>
    <div class="row">
      <div class="col-md-6">
        <h3>Connections Over Time</h3>
        <canvas id="connectionsChart" width="400" height="200"></canvas>
      </div>
      <div class="col-md-6">
        <h3>Denied Connections Over Time</h3>
        <canvas id="deniedChart" width="400" height="200"></canvas>
      </div>
    </div>
    <a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">Back to Dashboard</a>
  </div>

  <script>
    // Force only websocket transport; add logs
    var socket = io({ transports: ['websocket'] });

    // Basic Socket.IO diagnostics
    socket.on('connect', function() {
      console.log("Socket.IO: Connected via WebSocket.");
    });
    socket.on('connect_error', function(err) {
      console.error("Socket.IO: connect_error:", err);
    });
    socket.on('disconnect', function(reason) {
      console.log("Socket.IO: Disconnected. Reason:", reason);
    });

    // We'll store up to 200 points in each chart. You can change if you like.
    const MAX_POINTS = 200;

    // Listen for "metrics" events from server
    socket.on('metrics', function(data) {
      console.log("Received metrics:", data);

      // We record a time-based x-value
      const now = new Date(); 

      // 1) Connections
      connectionsChart.data.datasets[0].data.push({
        x: now,
        y: data.current_connections
      });
      // If we exceed MAX_POINTS, remove the oldest
      if (connectionsChart.data.datasets[0].data.length > MAX_POINTS) {
        connectionsChart.data.datasets[0].data.shift();
      }

      // 2) Denied (two separate lines)
      deniedChart.data.datasets[0].data.push({
        x: now,
        y: data.denied_by_threshold
      });
      if (deniedChart.data.datasets[0].data.length > MAX_POINTS) {
        deniedChart.data.datasets[0].data.shift();
      }

      deniedChart.data.datasets[1].data.push({
        x: now,
        y: data.denied_by_blocked
      });
      if (deniedChart.data.datasets[1].data.length > MAX_POINTS) {
        deniedChart.data.datasets[1].data.shift();
      }

      // Update each chart
      connectionsChart.update();
      deniedChart.update();
    });

    // =============================
    // Connections Chart Definition
    // =============================
    var ctx1 = document.getElementById('connectionsChart').getContext('2d');
    var connectionsChart = new Chart(ctx1, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Current Connections',
            data: [],   // We'll push points dynamically
            borderColor: 'rgba(75, 192, 192, 1)',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            // Time-based x-axis
            type: 'time',
            time: {
              unit: 'second',        // or 'minute' if you like
              displayFormats: {
                second: 'HH:mm:ss'   // show hours:minutes:seconds
              }
            },
            title: {
              display: true,
              text: 'Time'
            }
          },
          y: {
            beginAtZero: true,
            suggestedMax: 100, // raise if your "connections" goes higher than 100
            title: {
              display: true,
              text: 'Connections'
            }
          }
        }
      }
    });

    // ============================
    // Denied Chart Definition
    // ============================
    var ctx2 = document.getElementById('deniedChart').getContext('2d');
    var deniedChart = new Chart(ctx2, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Denied by Threshold',
            data: [],
            borderColor: 'rgba(255, 159, 64, 1)',
            fill: false
          },
          {
            label: 'Denied (Blocked IP)',
            data: [],
            borderColor: 'rgba(255, 99, 132, 1)',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'second',
              displayFormats: {
                second: 'HH:mm:ss'
              }
            },
            title: {
              display: true,
              text: 'Time'
            }
          },
          y: {
            beginAtZero: true,
            suggestedMax: 100, // raise if "denied" gets bigger
            title: {
              display: true,
              text: 'Denied Connections'
            }
          }
        }
      }
    });
  </script>
</body>
</html>
